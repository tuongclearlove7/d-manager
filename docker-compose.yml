services:
  socket-server:
    build: .
    image: d-manager:latest
    container_name: d-manager-socket-server
    command: python backend/app/main.py
    ports:
      - "9000:9000"
    restart: always
    volumes:
      - ./data:/app/data
    networks:
      - dmanager-net
    # Tạm thời xóa healthcheck để tránh lỗi "unhealthy"
    # Lý do: WebSocket server không có HTTP endpoint → curl http://localhost:9000 fail
    # Nếu muốn thêm lại sau, dùng TCP check (xem comment bên dưới)

    # Ví dụ healthcheck TCP-based (nếu cài netcat trong Dockerfile):
    # healthcheck:
    #   test: ["CMD-SHELL", "nc -z localhost 9000 || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 15s
    #   start_interval: 3s

  deploy-listen:
    image: d-manager:latest
    container_name: d-manager-deploy-listen
    command: python backend/app/listen.py
    environment:
      - WS_SERVER=ws://socket-server:9000
    depends_on:
      - socket-server          # Chỉ chờ start (không cần healthy)
    restart: always
    volumes:
      - .:/app                 # Mount code để git pull tự động áp dụng
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock  # Cần thiết cho listen.py chạy docker compose
    working_dir: /app
    networks:
      - dmanager-net

networks:
  dmanager-net:
    driver: bridge