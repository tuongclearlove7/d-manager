<!doctype html>
<html>
  <head>
    <title>Deploy Monitor</title>
  </head>
  <body>
    <h2>Realtime Deploy Events</h2>
    <div id="events"></div>

    <script>
      const WS_URL = "ws://103.161.97.193:9000";
      const container = document.getElementById("events");

      let ws;

      function connect() {
        ws = new WebSocket(WS_URL);

        // ğŸ”µ Khi báº¯t Ä‘áº§u káº¿t ná»‘i
        ws.onopen = function () {
          console.log("âœ… Connected to WebSocket server");
        };

        // ğŸ“¨ Khi nháº­n dá»¯ liá»‡u
        ws.onmessage = function (event) {
          const msg = JSON.parse(event.data);

          if (msg.type === "init") {
            msg.data.forEach(renderEvent);
          }

          if (msg.type === "deploy") {
            renderEvent(msg.data);
          }
        };

        // âŒ Khi cÃ³ lá»—i
        ws.onerror = function (error) {
          console.error("âŒ WebSocket error:", error);
        };

        // ğŸ”Œ Khi bá»‹ ngáº¯t káº¿t ná»‘i
        ws.onclose = function () {
          console.warn("âš ï¸ WebSocket disconnected. Reconnecting in 3s...");
          setTimeout(connect, 3000); // auto reconnect
        };
      }

      function renderEvent(data) {
        console.log("Received:", data);

        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.margin = "10px";
        div.style.padding = "10px";

        const files = Array.isArray(data.files_changed)
          ? data.files_changed.join(", ")
          : "N/A";

        div.innerHTML = `
      <b>Project:</b> ${data.project || data.service || "N/A"}<br>
      <b>Status:</b> ${data.status || "N/A"}<br>
      <b>Message:</b> ${data.message || "N/A"}<br>
      <b>Commit:</b> ${data.commit || "N/A"}<br>
      <b>Commit Message:</b> ${data.commit_message || "N/A"}<br>
      <b>Files:</b> ${files}<br>
      <b>Time:</b> ${data.time || "N/A"}
    `;

        container.prepend(div);
      }

      // ğŸš€ Báº¯t Ä‘áº§u connect
      connect();
    </script>
  </body>
</html>
